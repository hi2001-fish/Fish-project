#include <OneWire.h> 

#include <DallasTemperature.h> 

#include <Servo.h> 

#include <AccelStepper.h> 

 

// ----------------------------------- STEPPER SETUP ------------------------------------ 

#define dirPin 8 

#define stepPin 9 

 

AccelStepper stepper(AccelStepper::DRIVER, stepPin, dirPin); 

 

// Stepper positions  

 

const int fullIntake = 1478; //1.42L water intake  

const int equilibrium = 1414; //1.36L (neutral buoyancy)  

const int descentStopVolume = 1258; //expel 0.15L while descending  

const int ascentStopVolume = 1259; //slightly intake 0.149 L while ascending  

const int surfacePosition = 0; //Fully expel all water  

const int originalPosition = 0; // Original/reset position  

 

int currentPos = 0;  

bool isAscending = false; // Track ascent/descent mode  

 

// Failsafe variables  

 

unsigned long ascendPressStart = 0;  

bool ascendPressed = false;  

const unsigned long FAILSAFE_DURATION = 3000; // 3 seconds in milliseconds  

 

// ----------------------------------- SERVO SETUP ------------------------------------ 

Servo fishTail; // Creating servo object  

const int servoPin = 11; //Servo is connected to pin 11 on Arduino 

 

// Motion parameters  

const int centerPosition = 90;  

const int amplitude = 40;        // For normal swimming  

const int turnAngle = 85;        // 85 degrees off center for sharper turns  

  

// Speed settings (Hz)  

const float speedSlow = 0.8;  

const float speedMedium = 1.2;  

const float speedFast = 1.5;  

 

// Current state  

float currentFrequency = speedMedium;  // Start at medium speed  

bool turningLeft = false;  

bool turningRight = false;  

 

//------------------------------------ TEMP SENSOR SETUP ------------------------------ 

#define ONE_WIRE_BUS 2 // Data wire is connected to pin 2 on Arduino 

OneWire oneWire(ONE_WIRE_BUS); // Setup a oneWire instance to communicate with any OneWire device 

DallasTemperature sensors(&oneWire); // Pass oneWire reference to DallasTemperature library 

 

unsigned long lastTempRead = 0; 

const unsigned long tempInterval = 10000; // 10 seconds 

 

//------------------------------------ Functions -------------------------------------- 

void updateTailMotion(); 

void updateTemperature(); 

void moveToPosition(int targetPosition); 

void handleAscend(); 

void handleDescend(); 

void handleStop(); 

 

//------------------------------------ SETUP ------------------------------------------ 

void setup(void) { 

  Serial.begin(9600); 

  

  // Servo 

  fishTail.attach(servoPin);  

  fishTail.write(centerPosition);  

 

  // Temperature sensor 

  sensors.begin(); 

 

  // Stepper 

  stepper.setMaxSpeed(1000); 

  stepper.setAcceleration(500); 

  stepper.setCurrentPosition(0); 

  currentPos = 0; 

 

  Serial.println("System initialised."); 

} 

 

//------------------------------------ LOOP ------------------------------------------- 

void loop() { 

 

  // ---------------------------------- READ SERIAL COMMANDS --------------------------- 

  if (Serial.available()) { 

    String cmd = Serial.readStringUntil('\n'); 

    cmd.trim(); 

 

    // ---------------------------------- Servo speed commands --------------------------- 

    if (cmd == "SLOW") { 

      currentFrequency = speedSlow; 

      Serial.println("Tail speed: SLOW"); 

    } 

    else if (cmd == "MEDIUM") { 

      currentFrequency = speedMedium; 

      Serial.println("Tail speed: MEDIUM"); 

    } 

    else if (cmd == "FAST") { 

      currentFrequency = speedFast; 

      Serial.println("Tail speed: FAST"); 

    } 

 

    // --------------------------------- Servo direction commands ------------------------ 

    else if (cmd == "LEFT") { 

      turningLeft  = true; 

      turningRight = false; 

      Serial.println("Tail turning: LEFT"); 

    } 

    else if (cmd == "RIGHT") { 

      turningRight = true; 

      turningLeft  = false; 

      Serial.println("Tail turning: RIGHT"); 

    } 

    else if (cmd == "CENTER") { 

      turningLeft  = false; 

      turningRight = false; 

      Serial.println("Tail turning: CENTER"); 

    } 

 

    // ------------------------- Stepper / ballast commands --------------------------- 

    else if (cmd == "ASCEND") { 

      handleAscend(); 

    } 

    else if (cmd == "DESCEND") { 

      handleDescend(); 

    } 

    else if (cmd == "STOP") { 

      handleStop(); 

    } 

    else if (cmd == "SURFACE") { 

      Serial.println("Command: SURFACE (move to surface position)"); 

      moveToPosition(surfacePosition); 

    } 

    else if (cmd == "EQUILIBRIUM") { 

      Serial.println("Command: EQUILIBRIUM (move to equilibrium position)"); 

      moveToPosition(equilibrium); 

    } 

    else if (cmd == "RESET") { 

      Serial.println("Command: RESET (move to original position)"); 

      moveToPosition(originalPosition); 

    } 

    else { 

      Serial.print("Unknown command: "); 

      Serial.println(cmd); 

    } 

  } 

 

  // ----------------------------- SERVO MOTION UPDATE -------------------------------- 

  updateTailMotion(); 

 

  // ----------------------------- TEMPERATURE READING -------------------------------- 

  updateTemperature(); 

 

  // Stepper is moved in blocking fashion inside moveToPosition() 

  // so nothing needed here for stepper.run() in this version. 

 

  delay(20); // servo update rate 

} 

 

// ------------------------------------ FUNCTIONS ------------------------------------- 

 

void updateTailMotion() { 

  float timeSec = millis() / 1000.0; 

  float angle; 

 

  if (turningLeft) { 

    float oscillation = (1 - cos(2 * PI * currentFrequency * timeSec)) / 2; 

    angle = centerPosition - (turnAngle * oscillation); 

  } 

  else if (turningRight) { 

    float oscillation = (1 - cos(2 * PI * currentFrequency * timeSec)) / 2; 

    angle = centerPosition + (turnAngle * oscillation); 

  } 

  else { 

    angle = centerPosition + amplitude * sin(2 * PI * currentFrequency * timeSec); 

  } 

 

  angle = constrain(angle, 20, 160); 

  fishTail.write((int)angle); 

} 

 

void updateTemperature() { 

  if (millis() - lastTempRead >= tempInterval) { 

    lastTempRead = millis(); 

 

    sensors.requestTemperatures(); 

    float tempC = sensors.getTempCByIndex(0); 

    float tempF = tempC * 9.0 / 5.0 + 32.0; 

 

    Serial.print("Temperature: "); 

    Serial.print(tempC); 

    Serial.print(" °C  |  "); 

    Serial.print(tempF); 

    Serial.println(" °F"); 

  } 

} 

 

void moveToPosition(int targetPosition) { 

  stepper.moveTo(targetPosition); 

  while (stepper.distanceToGo() != 0) { 

    stepper.run(); 

  } 

  currentPos = targetPosition; 

  Serial.print("Current position: "); 

  Serial.println(currentPos); 

} 

 

// ----------------------------- HIGH-LEVEL STEPPER ACTIONS --------------------------- 

 

void handleAscend() { 

  isAscending = true; 

  Serial.println("Ascending: Moving to surface position."); 

  moveToPosition(surfacePosition); 

  delay(500); 

  Serial.println("Ascending: Returning to equilibrium position."); 

  moveToPosition(equilibrium); 

} 

 

void handleDescend() { 

  isAscending = false; 

  Serial.println("Descending: Moving to full intake position."); 

  moveToPosition(fullIntake); 

  delay(500); 

  Serial.println("Descending: Returning to equilibrium position."); 

  moveToPosition(equilibrium); 

} 

 

void handleStop() { 

  if (isAscending) { 

    Serial.println("Stop during ascent: Adjusting to ascent stop volume."); 

    moveToPosition(ascentStopVolume); 

    delay(250); 

    Serial.println("Returning to equilibrium position."); 

    moveToPosition(equilibrium); 

    delay(250); 

  } else { 

    Serial.println("Stop during descent: Adjusting to descent stop volume."); 

    moveToPosition(descentStopVolume); 

    delay(500); 

    Serial.println("Returning to equilibrium position."); 

    moveToPosition(equilibrium); 

  } 

} 

 

 
